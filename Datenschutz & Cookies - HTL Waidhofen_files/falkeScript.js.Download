jQuery(document).ready(function () {
	//jQuery(window).scroll(function () { console.log(arguments); })
	
	/** ie 10+ detection **/
	if(~window.navigator.userAgent.indexOf('MSIE ') || ~window.navigator.userAgent.indexOf('Trident/') || ~window.navigator.userAgent.indexOf('Edge/')){
		jQuery('body').addClass('ie');
	}

	/* anchor menu */
	var $headings = jQuery('.elementor h2.elementor-heading-title');
	if($headings.length > 0 && jQuery('.anchorMenu').length > 0){
		var string = '<h4 class="anchorMenuHeading">Schnellwahl:</h4><ul>';
		$headings.each(function(i,e){
			var $e = jQuery(e);
			var id = $e.html().replace(/[^a-zA-Z0-9]/g, "");
			$e.attr('id', id);
			$e.css('margin-top', '60px');
			string += '<li><a href="#'+id+'">'+$e.html()+'</a></li>';
		});
		jQuery('.anchorMenu').append(string + '</ul>');
	}else{
		jQuery('.anchorMenu').parent().parent().remove();
	}

	/* remove empty widgets */
	jQuery('.widget > div').each(function(i,e){
		if(jQuery(e).html().trim() == ''){
			jQuery(e).parent().remove();
		}
	});

	/* royal slider */
	if(jQuery('.homeSlider').length > 0){
		var homeSlider = jQuery('.homeSlider').royalSlider({
			imageScaleMode: 'fill',
			arrowsNav: false,
			loop: true,
			navigateByClick: false,
			keyboardNavEnabled: true,
			autoPlay:{
				enabled:true,
				delay: 5000
			}
		});
	}
	if(jQuery('.logoSlider').length > 0){
		var logoSlider = jQuery('.logoSlider').royalSlider({
			imageScalePadding: 25,
			loop: true,
			controlNavigation: 'none',
			randomizeSlides: true,
			navigateByClick: false,
			autoPlay:{
				enabled:true,
				delay: 3000
			}
		});
	}

	/* masonry */
	if(jQuery('.homeKacheln').length > 0){
		var homeKacheln = jQuery('.homeKacheln').masonry({
			itemSelector: '.kachel',
			columnWidth: '.kachelSizer',
			percentPosition: true
		});
		homeKacheln.imagesLoaded().progress(function(){
			homeKacheln.masonry('layout');
			setTimeout(function(){ homeKacheln.masonry('layout'); }, 1000);
		});

		/* instagram masonry element */
		// jQuery('.instagram-post').each(function(i,e){
		// 	var href = jQuery(e).data('href');
		// 	var split = href.split('instagram.com/p/');
		// 	if(split.length > 1){
		// 		split = split[1].split('/');
		// 		var instaId = split[0];
		//
		// 		jQuery(e).html('<div class="instaLayout"><iframe class="instaFrame" src="https://www.instagram.com/p/'+instaId+'/embed"></iframe></div>');
		// 		finished_rendering();
		// 		/*jQuery(e).load('https://www.instagram.com/p/'+instaId+'/embed',function(){
		// 			finished_rendering();
		// 		});*/
		// 	}
		// });
	}

	/* mobile navigation toggle */
	jQuery('.mobileNavButton').on('click', function(e){
		e.preventDefault();
		jQuery('.site-header').toggleClass('active');
		if(jQuery('.site-header').hasClass('active')){
			jQuery('body').addClass('noOverflow');
			jQuery(this).find('i').removeClass('fa-bars');
			jQuery(this).find('i').addClass('fa-times');
			jQuery('.mainNavCol').slideDown(500);
		}else{
			jQuery('body').removeClass('noOverflow');
			jQuery(this).find('i').addClass('fa-bars');
			jQuery(this).find('i').removeClass('fa-times');
			jQuery('.mainNavCol').slideUp(500);
		}
	});

	/* custom doubletap */
	jQuery( '.megaNav li:has(ul)' ).on('click', function(e){
		if(!jQuery(this).hasClass('hover')){
			e.preventDefault();

			$this = jQuery(this);

			jQuery( '.megaNav li:has(ul)' ).children( '.sub-menu' ).slideUp(500, function(){
				jQuery( '.megaNav li:has(ul)' ).removeClass( 'hover' );
				$this.addClass( 'hover' );
			});

			$this.children('.sub-menu').slideDown(500, function(){
				$this.addClass('hover');
			});

			if($this.hasClass('icon-suche')){
				$this.find('.search-form .search-field').focus();
			}
		}
	});
	jQuery( '.site-content, .site-footer' ).on('click', function(e){
		jQuery( '.megaNav li:has(ul)' ).removeClass('hover');
		jQuery( '.megaNav li:has(ul)' ).children( '.sub-menu' ).slideUp(500);
	});

	/* matchHeight helper */
	jQuery('.footer-menu > ul > li').matchHeight();
	jQuery('body:not(.elementor-editor-active) .mainContent, body:not(.elementor-editor-active) .sidebarContent').matchHeight();

	/** search form icon functionality **/
	jQuery('.search-form .search-icon').on('click', function(e){
		e.preventDefault();
		jQuery(this).parent().submit();
	});
	jQuery('.icon-suche a').on('click', function(e){
		e.preventDefault();
		jQuery(this).parent().find('.search-form .search-field').focus();
	});

	/* automatic targets of links */
	jQuery('a:not([href*="mailto:"],[href*="tel:"],[target*="_self"],[target*="_blank"])').attr('target', function() {
		if(this.host == location.host){
			return '_self';
		}else{
			return '_blank';
		}
	});

    //smooth scroll for anchor links
	jQuery('a[href*=#]').on('click', function(e) {
		var href = jQuery(this).attr('href').split('/');
		var selector = href[href.length - 1];
		//not for empty links like menu-toggle and elements on other pages
		if(selector != "#" && jQuery(selector).length > 0){
			e.preventDefault();
			jQuery('html, body').animate({ scrollTop: jQuery(selector).offset().top - 200}, 500, 'swing');
		}
	});

	/* megaNav media helper */
	jQuery('.megaNavHelperContainer > div').each(function(i,e){
		var name = jQuery(e).data('menuname');
		jQuery('.megaNav > ul > li').each(function(menuI,menuE){
			var hyperlink = jQuery(menuE).children('a');
			if(hyperlink.children('span').html()==name){
				if(jQuery(e).children('.bild-medium').length > 0){
					if(jQuery(menuE).children('.sub-menu').length > 0) jQuery(menuE).children('.sub-menu').append('<div class="megaNavMediaContainer"><a title="'+jQuery(e).children('.bild-caption').html()+'" class="megaNavImg" style="background-image:url('+jQuery(e).children('.bild-medium').html()+')"></a></div>');
				}
				if(jQuery(e).children('.youtube-url').length > 0){
					var ytTemp = getYtId(jQuery(e).children('.youtube-url').html());
					var ytId = ytTemp[0];
					var ytParams = '';
					if(ytTemp.length>1){
						for(i=1;i<ytTemp.length;i++){
							ytParams+='&'+ytTemp[i];
						}
					}

					if(jQuery(menuE).children('.sub-menu').length > 0 && ytId !== ''){
						if (jQuery('body').hasClass('cmplz-marketing')) {
							jQuery(menuE).children('.sub-menu').append('<div class="megaNavMediaContainer"><a href="https://www.youtube.com/watch?v='+ytId+ytParams+'" title="'+name+'" class="megaNavVid" style="background-image:url(https://img.youtube.com/vi/'+ytId+'/mqdefault.jpg)"></a></div>');
						}else{
							jQuery(menuE).children('.sub-menu').append('<div class="megaNavMediaContainer"></div>');
						}
					}
				}
			}
		});
	});

	/** magnific popup for elementor image widget **/
    jQuery('a[href$=".jpg"], a[href$=".jpeg"], a[href$=".png"], a[href$=".gif"], a[href$=".JPG"], a[href$=".JPEG"], a[href$=".PNG"], a[href$=".GIF"]').magnificPopup({
    	type:'image',
        image:{
            titleSrc: function(item){
            	var figcaption = jQuery(item.el).parent().find('figcaption').html();
            	if(typeof(figcaption) != 'undefined'){
            		return figcaption;
            	}else if('' !== item.el.attr('title') ){
            		return item.el.attr('title');
            	}else{
            		return item.el.find('img').attr('alt');
            	}
            }
        },
    	gallery:{
    		enabled:true,
    		tPrev:'Zurück',
    		tNext:'Weiter',
    		tCounter:'%curr% / %total%'
    	},
    	tClose:'Schließen',
    	tLoading:'Lädt ...'
    });
    /** magnific popup for elementor image carousel (closed loop) **/
    jQuery('.elementor-image-carousel').each(function(){
    	jQuery(this).magnificPopup({
    		delegate: 'a[href$=".jpg"], a[href$=".jpeg"], a[href$=".png"], a[href$=".gif"], a[href$=".JPG"], a[href$=".JPEG"], a[href$=".PNG"], a[href$=".GIF"]',
	    	type:'image',
	        image:{
	            titleSrc: function(item){
	            	var figcaption = jQuery(item.el).parent().find('figcaption').html();
	            	if(typeof(figcaption) != 'undefined'){
	            		return figcaption;
	            	}else{
	            		return item.el.find('img').attr('alt');
	            	}
	            }
	        },
	    	gallery:{
	    		enabled:true,
	    		tPrev:'Zurück',
	    		tNext:'Weiter',
	    		tCounter:'%curr% / %total%'
	    	},
	    	tClose:'Schließen',
	    	tLoading:'Lädt ...'
    	});
    });
    /** magnific popup for video links **/
    jQuery('a[href*="youtube.com/watch?v="]').magnificPopup({
		type:'iframe',
		iframe:{
			patterns:{
				youtube:{
					index:'youtube.com/',
					id:function(url){
						var ytTemp = getYtId(url);

						var ytParams = '?autoplay=1&rel=0';
						if(ytTemp.length>1){
							for(i=1;i<ytTemp.length;i++){
								ytParams += '&' + ytTemp[i];
							}
						}

						return ytTemp[0] + ytParams;
					},
					params:function(url){
						var ytTemp = getYtId(url);

					},
					//id:'v=',
					src:'//www.youtube.com/embed/%id%'
				}
			}
		},
		tClose:'Schließen',
		tLoading:'Lädt ...'
	});
	
	jQuery('a[href$=".mp4"], a[href$=".mov"], a[href$=".wmv"]').magnificPopup({
    	type:'iframe',
    	gallery:{
    		enabled:true,
    		tPrev:'Zurück',
    		tNext:'Weiter',
    		tCounter:'%curr% / %total%'
    	},
    	tClose:'Schließen',
    	tLoading:'Lädt ...'
    });

    /** instagram posts - extract text **/
    jQuery('.instagram-pics a').each(function(i,e){
    	jQuery(e).append('<span class="caption">'+jQuery(e).find('img').attr('alt')+'</span>');
    });

    /** change Text of some Mailchimp-Fields **/
    jQuery('#mc_embed_signup_scroll > div.indicates-required').html('<span class="asterisk">*</span> Pflichtfeld');
    jQuery('#mc-embedded-subscribe').attr('value','Jetzt anmelden');

	/** change data policy checkbox text in Mailchimp but it doesn't working**/
	jQuery('#mc-embedded-subscribe').on('click', function(e) {

		setTimeout(function(){

			if(jQuery('.gdprRequired .mce_inline_error').length > 0) {
				jQuery('.gdprRequired .mce_inline_error').html('Bitte die Datenschutzbestimmungen akzeptieren');
			}
			// console.log(jQuery('.gdprRequired .mce_inline_error'));

		}, 250);
	});

	/* FALKE Header Fullscreen NEU 2023  */

	/* open/close with button */
	jQuery('#falke-open-menu').click(function () {
		// if search is already open
		/*if (jQuery('.falke-active').length) {
			jQuery('.falke-active').removeClass('falke-active')
			jQuery('.falke-hidden').removeClass('falke-hidden')
		} else {
			jQuery('#falke-header').toggleClass('active')
			jQuery('body').toggleClass('falke-menu-open')
			jQuery('.current-active-item').removeClass('current-active-item')
			jQuery('.menu-hover').removeClass('menu-hover')
			jQuery('.falke-hidden').removeClass('falke-hidden')
		}*/
		// jQuery('body').scrollTop() // TODO needed?
		jQuery('.falke-active').removeClass('falke-active')
		jQuery('#falke-header').toggleClass('active')
		jQuery('.current-active-item').removeClass('current-active-item')
		jQuery('.menu-hover').removeClass('menu-hover')
		jQuery('.falke-hidden').removeClass('falke-hidden')
		delayMenuOpen()

		/* reposition menu */
		move_header_logo()
	})
	/* close on ESC */
	jQuery(document).on('keyup', function (e) {
		if (e.key == "Escape") {
			jQuery('#falke-header.active').removeClass('active')
			jQuery('.current-active-item').removeClass('current-active-item')
			jQuery('.menu-hover').removeClass('menu-hover')
			jQuery('.falke-hidden').removeClass('falke-hidden')
			jQuery('.falke-active').removeClass('falke-active')
			delayMenuOpen()

			/* reposition menu */
			jQuery('.header-logo-img').css('transform', `translate(0px, 0px)`)
		}
	})
	/* click on logo when open */
	jQuery('.header-logo-link.second').click(function (e) {
		e.preventDefault()
		jQuery('.falke-active').removeClass('falke-active')
		jQuery('.falke-hidden').removeClass('falke-hidden')
		jQuery('.current-active-item').removeClass('current-active-item')
	})
	/* click on links in menu */
	jQuery('#falke-header .falke-fullpage-menu-container a').click(function (e) {
		jQuery('.falke-active').removeClass('falke-active')
		//let parentClasses = jQuery(this).parent()[0].className

		// if current submenu is not open disable link and open it
		// but only if there is actually a submenu
		if (!jQuery(this).parents('.menu-hover').length && jQuery(this).parents('.menu-item-has-children').length) {
			e.preventDefault();
			// get id of current element
			let parentId = jQuery(this).parent().attr('id').split("-").pop()
	
			// mark current item
			jQuery('.menu-hover').removeClass('menu-hover')
			jQuery(this).parent().addClass('menu-hover')
			
			// show submenu
			jQuery('.current-active-item').removeClass('current-active-item')
			jQuery(`#falke-header .falke-fullpage-submenu-container .menu-item-${parentId}`).addClass('current-active-item')
			jQuery('.falke-header-dropdown').addClass('falke-open')

			// hide info-container
			jQuery('.info-container').addClass('falke-hidden')
		}
		// else use the link like usual
	})

	/* open/close search */
	jQuery('#falke-open-search').click(function () {
		// if menu is already open
		if (jQuery('.site-header.active').length && !jQuery('.info-container.falke-hidden').length) {
			jQuery('.search-container-whole').addClass('falke-active')
			jQuery('.info-container').addClass('falke-hidden')
		} else if (jQuery('.current-active-item').length) {
			jQuery('.current-active-item').removeClass('current-active-item')
			jQuery('.search-container-whole').addClass('falke-active')
			jQuery('.info-container').addClass('falke-hidden')
		} else {
			jQuery('.search-container-whole').addClass('falke-active')
			jQuery('#falke-header').toggleClass('active')
			jQuery('.current-active-item').removeClass('current-active-item')
			jQuery('.menu-hover').removeClass('menu-hover')
			jQuery('.info-container').addClass('falke-hidden') /* hide info box */
			delayMenuOpen()
		}
		/* reposition menu */
		jQuery('.header-logo-img').css('transform', `translate(0px, 0px)`)
	})

	function delayMenuOpen() {
		if (jQuery('.falke-menu-open').length) {
			setTimeout(function () {
				jQuery('body').toggleClass('falke-menu-open')
			}, 500)
		} else {
			/* display current menu items on subpages*/
			if (jQuery('body:not(.home)').length) {
				// current category is not set on news pages
				if (jQuery('.current-menu-parent').length) {
					current_item_id = jQuery('.current-menu-parent').attr("id").split('-')
					current_item_id = current_item_id[current_item_id.length - 1]
					jQuery('.falke-header-submenu-container .info-container').addClass('falke-hidden')
					jQuery(`.falke-fullpage-submenu-container li.menu-item-${current_item_id}`).addClass('current-active-item')
					jQuery(`.falke-fullpage-menu-container li.menu-item-${current_item_id}`).addClass('menu-hover')
				}
			}
			jQuery('body').toggleClass('falke-menu-open')
		}
	}

	function move_header_logo() {
		/* TODO invest further? */
		/*if (jQuery('.header-logo-img.moved').length) {
			console.log("remove")
			jQuery('.header-logo-img').css('transform', `translate(0px, 0px)`)
			jQuery('.moved').removeClass('moved')
		} else {
			console.log("add")
			let position_menu = jQuery('.falke-fullpage-menu-container').position()
			console.log(position_menu)
			let horizontal_position_menu = jQuery('.falke-fullpage-menu-container').offset().left + jQuery('.falke-fullpage-menu-container').width()
			let horizontal_position_image = jQuery('.header-logo-img').offset().left + jQuery('.header-logo-img').width()
			jQuery('.header-logo-img').css('transform', `translate(${horizontal_position_menu - horizontal_position_image}px, ${position_menu['top']}px)`)
			jQuery('.header-logo-img').addClass('moved')
		}*/
	}

	function throttle(func, delay) {
		// Previously called time of the function
		let prev = 0;
		return (...args) => {
		  // Current called time of the function
		  let now = new Date().getTime();
	   
		  // Logging the difference between previously
		  // called and current called timings
		  // console.log(now-prev, delay);
		   
		  // If difference is greater than delay call
		  // the function again.
		  if(now - prev> delay){
			prev = now;
	   
			// "..." is the spread operator here
			// returning the function with the
			// array of arguments
			return func(...args); 
		  }
		}
	}

	//detect page scroll and build sticky and mobile menu
	jQuery(window).on('scroll', function(){
		detectScroll();
	});
	function detectScroll(){
		if(jQuery(document).scrollTop() > 75){
			jQuery('html').addClass('falkeScrolled');
		}else{
			jQuery('html').removeClass('falkeScrolled');
		}
	}

	// footer carousel
	jQuery('.owl-carousel.footer-carousel').owlCarousel({
		margin: 20,
		stagePadding: 100,
		loop: true,
		stagePadding: 0,
		autoWidth: false,
		lazyLoad: true,
		autoplay: true,
		autoplayHoverPause: true,
		responsiveClass: true,
		responsive: {
		  	0: {
				items: 2,
				dots: false,
				margin: 10,
			},
			500: {
				items: 3,
				dots: true,
				margin: 10
			},
			768: {
				items: 6,
				dots: true,
				nav: false,
			},
			1025: {
				items: 10,
				dots: true,
				nav: false,
			}
		}
	});
	
	// beitragsnavigation
	// get slide to start at
	start_index = jQuery('.owl-carousel.falke-post-navigation-slider').data('start')
	count_slides = jQuery('.owl-carousel.falke-post-navigation-slider > div').length
	if (start_index >= count_slides) start_index = count_slides - 1
	jQuery('.owl-carousel.falke-post-navigation-slider').owlCarousel({
		margin: 20,
		stagePadding: 100,
		loop: false,
		stagePadding: 0,
		autoWidth: false,
		lazyLoad: true,
		autoplay: false,
		autoplayHoverPause: true,
		responsiveClass: true,
		responsive: {
		  	0: {
				items: 1,
				startPosition: ((start_index - 1) < 0) ? start_index : (start_index - 1),
				dots: true,
				nav: true,
				navText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"],
			},
			768: {
				items: 2,
				startPosition: ((start_index - 1) < 0) ? start_index : (start_index - 1),
				dots: true,
				nav: true,
				navText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"],
			},
			1100: {
				items: 3,
				startPosition: ((start_index - 2) >= 0) ? (start_index - 2) : ((start_index - 1) >= 0) ? (start_index - 1) : start_index,
				dots: true,
				nav: true,
				navText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"],
			}
		}
	  });
});

jQuery(document).ready(function () {
	/*--------------------------------------------------------------
	# SCROLL TO TOP
	--------------------------------------------------------------*/
	// browser window scroll (in pixels) after which the "back to top" link is shown
	var offset = 300,
	//browser window scroll (in pixels) after which the "back to top" link opacity is reduced
	offset_opacity = 1200,
	//grab the "back to top" link
	back_to_top = jQuery('.cd-top');

	//hide or show the "back to top" link
	jQuery(window).scroll(function(){
		( jQuery(this).scrollTop() > offset ) ? back_to_top.addClass('cd-is-visible') : back_to_top.removeClass('cd-is-visible cd-fade-out');
		if( jQuery(this).scrollTop() > offset_opacity ) {
			back_to_top.addClass('cd-fade-out');
		}
	});
})

/*--------------------------------------------------------------
# YOUTUBE HELPER
--------------------------------------------------------------*/
function getYtId(url){
	var split = url.split("youtube.com/watch?v=");
	if(split.length > 1){
		var nextSplit = split[1].split('&');
		var ret = new Array();
		ret.push(nextSplit[0]);
		for(i=1;i<nextSplit.length;i++){
			ret.push(nextSplit[i]);
		}
		return ret;
	}else{
		var split = url.split("youtu.be/");
		if(split.length > 1){
			var nextSplit = split[1].split('?');
			var ret = new Array();
			ret.push(nextSplit[0]);
			for(i=1;i<nextSplit.length;i++){
				ret.push(nextSplit[i]);
			}
			return ret;
		}
	}
	return false;
}

/*--------------------------------------------------------------
# FACEBOOK SDK CALLBACK (OLD TPL-HOME.PHP)
--------------------------------------------------------------
function finished_rendering() {
	jQuery('.homeKacheln').masonry('layout');
	setTimeout(function(){ jQuery('.homeKacheln').masonry('layout'); }, 500);
}*/
